PHK;01;2;Pesquisar;1;AxPesqui();;;
PHK;02;2;Visualizar;2;AxVisual("PHK", PHK->(Recno()),2);;;
PHK;03;2;Importar;3;nTypeImp := 2;;
__ALIAS := aQuery[1][2]:cAlias;;
MsAguarde({|| U_ExecSQL(M->PQ6_GDVPL) },"Aguarde...","Deletando temporario");;
U_TRGXLCSV();;
MsAguarde({|| U_ExecSQL(M->PQ6_SQL) },"Aguarde...","Gerando Tabela de BUFFER");;
__REFRESH := .T.
;DELETE FROM <ADVPL>RetSqlName("PHK")</ADVPL>;;
DELETE FROM <ADVPL>RetSqlName("PZZ")</ADVPL> WHERE PZZ_FILIAL = ' ' AND PZZ_DTASS < '20220401';;
INSERT INTO <ADVPL>RetSqlName("PHK")</ADVPL>(PHK_UNINEG, PHK_CODCLI, PHK_CONTRA, PHK_PROPOS, PHK_ITEM, PHK_NUMERO, PHK_PRODUT, PHK_QUANT, PHK_VLUNIT, PHK_VLTOT, PHK_VLBRUT, PHK_TPIMP, PHK_QTDPER, PHK_ALIQ, PHK_MOEDA, 
       PHK_STATUS, PHK_VIGINI, PHK_VIGFIM, PHK_TMPMED, PHK_CARINI, PHK_CARFIM, PHK_QTDCAR, PHK_DIFINI, PHK_CMPDIF, PHK_MESDIF, PHK_VLDIF, PHK_VLRESI, PHK_VLAJUS, PHK_VLCARE, 
	   PHK_VLFATU, PHK_VLREPR, PHK_CTCMS, PHK_CTIMDF, PHK_ITCTB, PHK_CLVL, PHK_CCUSTO, PHK_CTDIF, PHK_LINREC, PHK_DTCTB, PHK_DTOPER, PHK_DTEST, PHK_DTMAN, PHK_HRMAN, PHK_HORA, 
	   PHK_CODMAN, PHK_ORIGEM, PHK_GRPEMP, PHK_MANUAL, PHK_LOTE, PHK_MOTMAN, PHK_CUSER, PHK_PARPER, PHK_ID, PHK_PERCMS, PHK_CMPCAN, PHK_QTDCAN, 
	   PHK_MOTCAN, PHK_TPCAN, PHK_SITUAC, PHK_VLCAN, PHK_VLFIM, PHK_VLLIQ, PHK_CTBBUF, PHK_MOTCAL, PHK_VLIMP, PHK_ALIQNF, PHK_CTBIMP, PHK_CTBLIQ, PHK_VLCOMI, PHK_CTBCOM,
	   R_E_C_N_O_)                                           
SELECT '02601000100' AS PHK_UNINEG, TMP.A1_COD, PHK_CONTRA, PHK_PROPOS, PHK_ITEM, PHK_NUMERO, PHK_PRODUT, PHK_QUANT, PHK_VLUNIT, PHK_VLTOT, PHK_VLBRUT, PHK_TPIMP, PHK_QTDPER, PHK_ALIQ, PHK_MOEDA, PHK_STATUS, 
       PHK_VIGINI, PHK_VIGFIM, PHK_TMPMED, PHK_CARINI, PHK_CARFIM, PHK_QTDCAR, PHK_DIFINI, PHK_CMPDIF, PHK_MESDIF, PHK_VLDIF, PHK_VLRESI, PHK_VLAJUS, PHK_VLCARE, PHK_VLFATU, 
	   PHK_VLREPR, PHK_CTCMS, PHK_CTIMDF, PHK_ITCTB, PHK_CLVL, PHK_CCUSTO, PHK_CTDIF, PHK_LINREC, PHK_DTCTB, PHK_DTOPER, PHK_DTEST, PHK_DTMAN, PHK_HRMAN, PHK_HORA, PHK_CODMAN, 
	   PHK_ORIGEM, PHK_GRPEMP, PHK_MANUAL, PHK_LOTE, PHK_MOTMAN, PHK_CUSER, PHK_PARPER, PHK_ID, PHK_PERCMS, ' ' AS PHK_CMPCAN, 0 AS PHK_QTDCAN, ' ' AS PHK_MOTCAN, 
	   ' ' AS PHK_TPCAN, 'A' AS PHK_SITUAC, 0 AS PHK_VLCAN, PHK_VLFIM, 
	   ROUND(PHK_VLFIM - (PHK_VLFIM - ((PHK_VLCARE + PHK_VLFATU - 0 +  PHK_VLREPR) * PHK_ALIQNF)), 2) AS PHK_VLLIQ, 
	   PHK_CTBBUF, ' ' AS PHK_MOTCAL, 
	   ROUND(PHK_VLFIM - ((PHK_VLCARE + PHK_VLFATU - 0 +  PHK_VLREPR) * PHK_ALIQNF), 2) AS PHK_VLIMP, PHK_ALIQNF, 
	   ROUND(PHK_CTBBUF - (PHK_CTBBUF * PHK_ALIQNF), 2) AS PHK_CTBIMP, 
	   ROUND(PHK_CTBBUF - (PHK_CTBBUF - (PHK_CTBBUF * PHK_ALIQNF)), 2) AS PHK_CTBLIQ, 
	   ROUND((PHK_CTBBUF - (PHK_CTBBUF - (PHK_CTBBUF * PHK_ALIQNF))) * PHK_PERCMS, 2) AS PHK_VLCOMI, 	   
	   ROUND((PHK_CTBBUF - (PHK_CTBBUF - (PHK_CTBBUF * PHK_ALIQNF))) * (PHK_PERCMS / 100), 2) AS PHK_CTBCOM, TMP.R_E_C_N_O_
  FROM (SELECT PHK_UNINEG, A1_COD, PHK_CONTRA, PHK_PROPOS, PHK_ITEM, PHK_NUMERO, PHK_PRODUT, PHK_QUANT, PHK_VLUNIT, PHK_VLTOT, PHK_VLBRUT, PHK_TPIMP, PHK_QTDPER, PHK_ALIQ, PHK_MOEDA, 
               PHK_STATUS, PHK_VIGINI, PHK_VIGFIM, PHK_TMPMED, PHK_CARINI, PHK_CARFIM, PHK_QTDCAR, PHK_DIFINI, PHK_CMPDIF, PHK_MESDIF, PHK_VLDIF, PHK_VLRESI, PHK_VLAJUS, 
			   PHK_VLCARE, PHK_VLFATU, PHK_VLREPR, PHK_CTCMS, PHK_CTIMDF, PHK_ITCTB, PHK_CLVL, PHK_CCUSTO, PHK_CTDIF, PHK_LINREC, PHK_DTCTB, PHK_DTOPER, PHK_DTEST, 
			   PHK_DTMAN, PHK_HRMAN, PHK_HORA, PHK_CODMAN, PHK_ORIGEM, PHK_GRPEMP, PHK_MANUAL, PHK_LOTE, PHK_MOTMAN, PHK_CUSER, PHK_PARPER, PHK_ID, PHK_PERCMS, 
			   PHK_ALIQNF, PHK_VLCARE + PHK_VLFATU - PHK_VLREPR AS PHK_VLFIM, 
			   CASE WHEN PHK_VLAJUS > (PHK_VLCARE + PHK_VLFATU - PHK_VLREPR) THEN PHK_VLAJUS ELSE (PHK_VLCARE + PHK_VLFATU - PHK_VLREPR) END AS PHK_CTBBUF,
			   ROW_NUMBER() OVER (ORDER BY TMP.A1_CGC, PHK_PRODUT) AS R_E_C_N_O_
	      FROM <ADVPL>aQuery[1][2]:cArqTrb</ADVPL> TMP
          JOIN <ADVPL>RetSqlName("SA1")</ADVPL> SA1 ON A1_FILIAL = ' ' AND SA1.A1_CGC = TMP.A1_CGC AND SA1.D_E_L_E_T_ = ' ') TMP;;
INSERT INTO <ADVPL>RetSqlName("PZZ")</ADVPL>(PZZ_CODASS, PZZ_CNPJ, PZZ_DTASS, PZZ_STATUS, PZZ_CODCLI, PZZ_CODPRO, PZZ_PERIOD, PZZ_QUANT, PZZ_VLUNIT, PZZ_VLTOT, PZZ_CAREN,
       PZZ_UNINEG, PZZ_XITCTA, PZZ_XCLVL, PZZ_XCCUST, R_E_C_N_O_)
SELECT CASE WHEN TMP.PZZ_CODASS <> ' ' THEN TMP.PZZ_CODASS ELSE TMP.A1_CGC END AS PZZ_CODASS, TMP.A1_CGC AS PZZ_CNPJ, MIN(PHK_VIGINI) AS PZZ_DTASS, 'A' AS PZZ_STATUS, 
       MIN(A1_COD) AS PZZ_CODCLI, PHK_PRODUT AS PZZ_CODPRO, MAX(PHK_QTDPER) AS PZZ_PERIOD, MAX(PHK_QUANT) AS PZZ_QUANT, MAX(PHK_VLUNIT) AS PZZ_VLUNIT, 
	   MAX(PHK_VLTOT) AS PZZ_VLTOT, MAX(PHK_QTDCAR) AS PZZ_CAREN, '02601000100' AS PZZ_UNINEG, MIN(PHK_ITCTB) AS PZZ_XITCTA, MIN(PHK_CLVL) AS PZZ_XCLVL, 
	   MIN(PHK_CCUSTO) AS PZZ_XCCUST, ROW_NUMBER() OVER (ORDER BY TMP.A1_CGC, PHK_PRODUT) AS R_E_C_N_O_
  FROM <ADVPL>aQuery[1][2]:cArqTrb</ADVPL> TMP
  JOIN <ADVPL>RetSqlName("SA1")</ADVPL> SA1 ON A1_FILIAL = ' ' AND SA1.A1_CGC = TMP.A1_CGC AND SA1.D_E_L_E_T_ = ' '	   
 GROUP BY CASE WHEN TMP.PZZ_CODASS <> ' ' THEN TMP.PZZ_CODASS ELSE TMP.A1_CGC END, TMP.A1_CGC, PHK_PRODUT;DELETE FROM <ADVPL>aQuery[1][2]:cArqTrb</ADVPL>;
